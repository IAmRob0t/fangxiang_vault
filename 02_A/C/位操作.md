---
tags:
  - C
  - 位操作
---

> 位操作（Bitwise Operations）是C语言的一项重要特性，允许直接操作变量的二进制位。在嵌入式开发中，它对于高效读写硬件寄存器、节省内存空间及优化性能至关重要。

# 1. 位运算符

| 运算符 | 名称   | 描述                    |
| :-: | :--- | :-------------------- |
|  &  | 按位与  | 两位都为1时，结果为1，否则为0      |
| \|  | 按位或  | 两位中只要有 1，结果就为 1，否则为 0 |
|  ^  | 按位异或 | 两位相同时为0，不同时为1         |
|  ~  | 按位取反 | 0变为1，1变为0             |
| <<  | 左移   | 所有位向左移动指定的位数          |
| >>  | 右移   | 所有位向右移动指定的位数          |

# 2. 移位运算 (`<<` 和 `>>`)

移位运算在二进制层面直接移动数据位，执行效率极高。

*   **左移 (`<<`)**: `a << n` 将 `a` 的所有位向左移动 `n` 位。低位（最右边）空出的位置补0。对于无符号整数，这相当于 `a * 2^n`。
*   **右移 (`>>`)**: `a >> n` 将 `a` 的所有位向右移动 `n` 位。
    *   对于 **无符号类型** (`unsigned`)：高位（最左边）空出的位置补0（逻辑右移）。
    *   对于 **有符号类型** (`signed`)：高位空出的位置补符号位（算术右移），以保持数值的正负。

> 在嵌入式编程中，由于通常处理的是寄存器和标志位，我们主要关注 **无符号类型** 的移位行为，即逻辑移位。

示例：

```c
unsigned int a = 0b0001; // a = 1
// 左移两位
unsigned int b = a << 2; // b = 0b0100 (等于 4)

// 右移两位
unsigned int c = 4 >> 2; // c = 0b0001 (等于 1)
```

# 3. 常用位操作技巧

位操作的核心是巧妙运用 **位掩码 (Bitmask)**。位掩码是一个特定二进制模式的数值，用于在不影响其他位的前提下，选择性地操作目标数据的某些位。

## a. 读取特定位

**目的**：判断变量的第 `n` 位（从0开始计数）是否为1。
**方法**：使用按位与 `&` 运算符和左移 `1 << n` 创建的掩码。

```c
// 检查变量 a 的第 3 位是否为 1
if (a & (1 << 3)) {
    // 第 3 位是 1
} else {
    // 第 3 位是 0
}
```

## b. 设置特定位 (置位)

**目的**：将变量的第 `n` 位强制设置为1，不影响其他位。
**方法**：使用按位或 `|` 运算符和 `1 << n` 创建的掩码。

```c
// 将变量 a 的第 3 位和第 5 位设置为 1
a |= (1 << 3) | (1 << 5);
```

## c. 清除特定位 (清位)

**目的**：将变量的第 `n` 位强制设置为0，不影响其他位。
**方法**：使用按位与 `&` 运算符和 `~(1 << n)` 创建的掩码。

```c
// 清除变量 a 的第 3 位
a &= ~(1 << 3);
```

## d. 翻转特定位

**目的**：反转变量的第 `n` 位状态（0变1，1变0）。
**方法**：使用按位异或 `^` 运算符和 `1 << n` 创建的掩码。

```c
// 翻转变量 a 的第 3 位
a ^= (1 << 3);
```

## e. 设置或提取多位 (N-bits)

**目的**：将变量中从第 `pos` 位开始的 `len` 个位设置为 `value`，或从这些位中提取值。

**1. 设置多位**
**方法**：
1.  **清零目标位**：创建一个 `len` 长度的掩码，左移 `pos` 位，然后取反后与原变量进行 `&` 操作。
    掩码可以通过 `(1 << len) - 1` 创建一个 `len` 个1的序列。
2.  **赋值**：将 `value` 左移 `pos` 位后，与清零后的原变量进行 `|` 操作。

```c
// 示例：将变量 a 中从第 7 位开始的 2 个位 (即 bit[8:7]) 设置为 val (假设 val 是一个 2 位数)
unsigned int a = 0x1234; // 原始值
unsigned int val = 0b10; // 要设置的值，例如 2

unsigned int len = 2; // 位长度
unsigned int pos = 7; // 起始位

// 1. 创建 N-bits 全为1的掩码 (例如 2-bits: 0b11)
unsigned int mask_ones = (1 << len) - 1; // 得到 0b11

// 2. 将掩码左移到目标位置
unsigned int target_mask = mask_ones << pos; // 得到 0b110000000 (0x3 << 7)

// 3. 清零目标位
a &= ~target_mask;

// 4. 将 val 左移到目标位置后合并
a |= (val << pos);

// 此时 a 的 bit[8:7] 已经被设置为 val 的值
```

**2. 提取多位**
**方法**：
1.  **右移**：将目标位右移到最低位。
2.  **掩码**：使用 `(1 << len) - 1` 创建一个 `len` 个1的掩码，与右移后的结果进行 `&` 操作。

```c
// 示例：从变量 a 中提取从第 7 位开始的 2 个位 (即 bit[8:7]) 的值
unsigned int a = 0x12A4; // 假设 a 的 bit[8:7] 是 0b10 (2)
unsigned int len = 2; // 位长度
unsigned int pos = 7; // 起始位

// 1. 将目标位右移到最低位
unsigned int extracted_val = a >> pos;

// 2. 使用掩码提取
extracted_val &= ((1 << len) - 1);

// 此时 extracted_val = 0b10 (即 2)
```