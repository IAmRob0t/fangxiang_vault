---
tags:
  - C
  - 位操作
---

> 位操作(Bitwise Operations in C) 是C语言的一大特色，它允许程序员直接对变量在内存中的二进制位进行操作。在嵌入式开发中，位操作对于高效读写硬件寄存器、节省内存空间至关重要。

# 1. 位运算符

| 运算符 | 名称     | 描述                               |
| :----: | :------- | :--------------------------------- |
| `&`    | 按位与   | 两位都为1时，结果为1，否则为0      |
| `|`    | 按位或   | 两位中只要有1，结果就为1，否则为0  |
| `^`    | 按位异或 | 两位相同时为0，不同时为1           |
| `~`    | 按位取反 | 0变为1，1变为0                     |
| `<<`   | 左移     | 所有位向左移动指定的位数           |
| `>>`   | 右移     | 所有位向右移动指定的位数           |

---

# 2. 移位运算 (`<<` 和 `>>`)

移位运算在二进制层面移动数据位，效率极高。

*   **左移 (`<<`)**: `a << n` 相当于 `a * 2^n`。低位补0，高位丢弃。
*   **右移 (`>>`)**: `a >> n` 相当于 `a / 2^n`。
    *   **逻辑右移**：用于 `unsigned` 无符号类型。高位补0。
    *   **算术右移**：用于 `signed` 有符号类型。高位补充符号位（正数补0，负数补1），以保持数的正负。

> 在嵌入式开发中，我们通常处理无符号的寄存器地址和数据，因此主要使用 **逻辑移位**。

**示例：**
```c
unsigned int a = 0b0001; // a = 1
// 逻辑左移两位
unsigned int b = a << 2; // b = 0b0100 (等于 4)

// 逻辑右移两位
unsigned int c = 4 >> 2; // c = 0b0001 (等于 1)
```

---

# 3. 常用位操作技巧

位操作的核心在于 **位掩码 (Bitmask)** 的运用。位掩码是一个特定模式的二进制数，用于选择性地修改或读取目标数据。

## a. 读取特定位 (Reading a Bit)

**方法**：使用 `&` 运算符。
**场景**：判断第 `n` 位是否为1。

```c
// 检查变量 a 的第 3 位是否为 1
if (a & (1 << 3)) {
    // 第 3 位是 1
} else {
    // 第 3 位是 0
}
```

## b. 设置特定位 (Setting a Bit / 置位)

**方法**：使用 `|` 运算符。
**场景**：将第 `n` 位强制设置为1，不影响其他位。

```c
// 将变量 a 的第 3 位和第 5 位设置为 1
a = a | (1 << 3) | (1 << 5);

// 也可以简写为
a |= (1 << 3) | (1 << 5);
```

## c. 清除特定位 (Clearing a Bit / 清位)

**方法**：使用 `&` 和 `~` 运算符。
**场景**：将第 `n` 位强制设置为0，不影响其他位。

```c
// 清除变量 a 的第 3 位
a = a & ~(1 << 3);

// 简写为
a &= ~(1 << 3);
```

## d. 翻转特定位 (Toggling a Bit)

**方法**：使用 `^` (异或) 运算符。
**场景**：翻转第 `n` 位的状态 (0变1，1变0)。

```c
// 翻转变量 a 的第 3 位
a = a ^ (1 << 3);

// 简写为
a ^= (1 << 3);
```

## e. 设置连续几位为特定值

**场景**：将 `a` 的 `bit[8:7]` 设置为 `val` 的值 (`val` 是一个2位数)。

**步骤**：
1.  **清零**：先将目标位清零。
2.  **赋值**：再将 `val` 左移相应位数后，用 `|` 运算合并。

```c
unsigned int a = 0x123;
unsigned int val = 0b10; // 假设要设置的值为 2

// 1. 创建掩码并清零 bit[8:7]
// 3 的二进制是 11，(3 << 7) 的二进制是 110000000
a &= ~(3 << 7); 

// 2. 将 val 左移后合并
a |= (val << 7);
```


