---
tags:
  - freeRTOS
---

# 为什么要自己实现内存管理

为了让 FreeRTOS 更容易使用，这些内核对象一般都是动态分配：用到时分配，不使用时释放。使用内存的动态管理功能，简化了程序设计：不再需要小心翼翼地提前规划各类对象，简化 API 函数的涉及，甚至可以减少内存的使用。

在 C 语言的库函数中，有 `mallc`、`free` 等函数，但是在 FreeRTOS 中，它们不适用：
- 不适合用在资源紧缺的嵌入式系统中
- 这些函数的实现过于复杂、占据的代码空间太大
- 并非线程安全的(thread-safe)
- 运行有不确定性：每次调用这些函数时花费的时间可能都不相同
- 内存碎片化
- 使用不同的编译器时，需要进行复杂的配置
- 有时候难以调试

注意：我们经常"堆栈"混合着说，其实它们不是同一个东西：
- [[04_A/Data Structure/堆]] ，heap，就是一块空闲的内存，需要提供管理函数
	- `malloc`：从堆里划出一块空间给程序使用
	- `free`：用完后，再把它标记为"空闲"的，可以再次使用
- [[04_A/Data Structure/栈]] ，stack，函数调用时，局部变量和当前函数的调用环境保存在栈的栈帧中
	- 在 FreeRTOS 中，创建任务时可以选择从堆（heap_x.c 管理的堆内存）中动态分配一块内存作为该任务的栈空间。

![[FreeRTOS完全开发手册之上册_快速入门.pdf#page=24&rect=45,442,547,828|FreeRTOS完全开发手册之上册_快速入门, p.24]]

# FreeRTOS 的 5 中内存管理方法

FreeRTOS 中内存管理的接口函数为：`pvPortMalloc` 、`vPortFree`，对应于 C 库的 `malloc`、`free`。

文件在 FreeRTOS/Source/portable/MemMang 下，它也是放在 portable 目录下，表示你可以提供自己的函数。

[FreeRTOS说明书吐血整理【适合新手+入门】-CSDN博客](https://blog.csdn.net/qq_43212092/article/details/104845158)

( [[FreeRTOS完全开发手册之上册_快速入门.pdf#page=25&selection=66,0,70,4&color=note|📖]])
源码中默认提供了5个文件，对应内存管理的5种方法。

## Heap_1

## Heap_2

## Heap_3

## Heap_4

## Heap_5

# Heap 相关的函数

( [[FreeRTOS完全开发手册之上册_快速入门.pdf#page=30&selection=0,4,1,5&color=note|📖]])
Heap相关的函数

## `pvPortMalloc` / `vPortFree`

## `xPortGetFreeHeapSize`

##  `xPortGetMinimumEverFreeHeapSize`

## `malloc` 失败的钩子函数