---
tags:
  - freeRTOS
---

# 1. 需求与实现

## 1.1 设计需求

![image-20211117191055996](10_prj_request.png)

## 1.2 程序的多任务框架

![image-20211117183221739](03_all_tasks.png)

## 1.3 设计思想

* 对于模块，使用面向对象的思想编写程序，比如：
	* AT24C02
	* 数码管
	* 按键

# 2. `main` 函数

![image-20211117171249962](01_create_start_task.png)

# 3. 起始任务

![image-20211117171858164](02_start_task_detail.png)



## 3.1 创建 `host` 任务

用于管理：传送带、音乐、激活状态等，不是玩家独占的，

所以使用一个 `host` 任务来处理

## 3.2 创建 `listen` 任务

每个玩家都有3个数码管，但是这9个数码管都是使用同一条SPI总线控制，

所以：使用一个 `listen` 任务来管理数码管，它还可以更新玩家的按键

# 4. 主机任务

## 4.1 创建

![image-20211117171843899](04_host_task.png)

## 4.2 功能

![image-20211117183645107](05_host_task_detail.png)



# 5. `Listen` 任务

每个玩家都有3个数码管，但是这9个数码管都是使用同一条SPI总线控制，

所以：使用一个 `listen` 任务来管理数码管，

它还可以更新玩家的按键。

## 5.1 数码管显示

### 5.1.1 发送显示请求

以player1任务为例：

![image-20211117185952017](06_send_seg_request.png)

### 5.1.2 操作数码管

`listen` 任务从队列得到请求，显示数码管：

![image-20211117190311578](07_disp_seg.png)

# 6. 玩家任务

## 6.1 代码展示

![image-20211117190447017|1001](08_player_task.png)

任务优先级相同会轮流执行，所以其实并不需要使用 `vTaskDelay()` 主动放弃 CPU 资源

## 6.2 游戏逻辑

里面处理投币、发球器等，都是使用状态机轮询处理。

![image-20211117190605546](09_game_logical.png)

改进：
- 硬件：尽量使用中断引脚
- 无中断引脚： 使用 Timer 检测 pin / 写队列

# 7. UI任务

这是用于后台管理，比如：

* 设置一个币出多少个球
* 多少分得到礼物



