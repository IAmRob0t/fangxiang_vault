---
tags:
  - dataStructure
---
# 栈是什么？

栈是一种后进先出(LIFO: Last In First Out)的数据结构。在ARM等微控制器中，栈主要用于：

1. 函数调用：**保存返回地址(LR寄存器)和局部变量**
2. 上下文切换：保存和恢复寄存器状态
3. 临时数据存储：为局部变量和临时数据分配内存空间

栈默认是从高地址向低地址生长，当我们执行PUSH操作时，栈指针(SP)减小；执行POP操作时，栈指针增大。在嵌入式系统中，栈空间通常是有限的，需要谨慎管理以避免栈溢出。

# 谁分配栈 / 如何分配栈？

```asm
__Vectors       DCD     0x20000000+0x10000
```

CPU 一上电，就会从异常向量表中把第一个数值存入到栈寄存器 `0x2000 0000` 里面。

为什么取这个数值，是因为 F103 芯片的内存基地址是 `0x2000 0000` ，结束地址是 `0x2001 0000`

在编译、链接程序的时候，我们会告诉编译器，在 `0x2000 0000` 至 `0x2001 0000` 中，前面的空间用来分配全局/静态变量，由于后面的空间没有利用到，于是我们可以把栈设置在这里，它大概率不会破坏到前面的数据空间

# 栈的使用

```asm
0x08000024 B508      PUSH     {r3,lr}	// 入栈
```

![[04_A/Data Structure/attachments/栈_01.png|980]]

编译调试以下程序我们发现

```c
int mymain()
{
  static volatile int s_a = 1;
  
  volatile int b;
  
  b = add_val(s_a);
  
  return 0;
}
```

| Name | Value      |
| ---- | ---------- |
| `b`  | 0x00000000 |
| `&b` | 0x2000FFF8 |

- 为什么变量 `b` 的地址这么奇怪？
- 原来 `R3` 就是变量 `b`

- `PUSH     {r3,lr}` 的作用
	- 保存 LR
	- 用 R3 来占坑，给变量 `b` 分配空间

```asm
    19:   volatile int b = 456; 
    20:    
0x08000026 F44F70E4  MOV      r0,#0x1C8		// r0 = 456
0x0800002A 9000      STR      r0,[sp,#0x00]	// r0 => [sp, #0] => [2000FFF8] 即变量 b
```

---

```asm
    15: int mymain() 
0x08000020 BD0C      POP      {r2-r3,pc}
0x08000022 0000      MOVS     r0,r0
```

- `POP      {r2-r3,pc}` 的作用
	- ![[04_A/Data Structure/attachments/栈_02.png|693]]

---

> [!question] 如何估计栈的大小？
> 寻找使用局部变量最多的调用栈
