---
tags:
  - K210
---

# 颜色追踪

## 1. 相关方法

在`CanMV` 中可以通过调用 `find_blobs` 方法来寻找色块。方法调用方式如下：

```python
image.find_blobs(thresholds, roi=Auto, x_stride=2, y_stride=1, 
	 invert=False, area_threshold=10, pixels_threshold=10, 
	 merge=False, margin=0, threshold_cb=None, merge_cb=None)
```

函数接口定义可以参考 [[image-图像处理#2.2.76. `find_blobs`|find_blobs]]

## 2. 颜色阈值

颜色阈值的结构定义如下：

```python
red = (minL, maxL, minA, maxA, minB, maxB)
```

## 3. 参数设置技巧

`CanMV IDE` 自带的阈值编辑器，可以方便我们进行阈值调节设定。

首先，在 `CanMV IDE` 里运行 `helloworld.py` 程序，进行图像采集。 然后我们依次点击 “工具” > “机器视觉” > “阈值编辑器”，在源图像位置选择“帧缓冲区”。

![open_thre](https://developer.canaan-creative.com/canmv/main/_images/blob_open_thre.jpg)

这时我们可以拖动滑动条，进行阈值调整，并观测预览区域，直到预览区域只保留我们想要检测的区域，记录下此时的数值。

![adjust_thre](https://developer.canaan-creative.com/canmv/main/_images/blob_thre.jpg)

## 4. 示例程序演示

下面的示例演示了如何通过 `CanMV` 检测手机里的红色色块。  
上面我们已经利用阈值编辑器得到相应的阈值，将它粘贴到例程的 thresholds 中。然后点击运行程序，即可开始进行色块追踪。

```python
import sensor, image, time, math

# 更改阈值
thresholds = [(27, 70, 10, 100, 4, 76)]

sensor.reset()
sensor.set_pixformat(sensor.RGB565)
sensor.set_framesize(sensor.QVGA)
sensor.skip_frames(time = 2000)
sensor.set_auto_gain(False) # must be turned off for color tracking
sensor.set_auto_whitebal(False) # must be turned off for color tracking
clock = time.clock()

while(True):
    clock.tick()
    img = sensor.snapshot()
    for blob in img.find_blobs(thresholds, pixels_threshold=100, area_threshold=100, 
                               merge=True):
        if blob.code() == 1:
            img.draw_rectangle(blob.rect())
            img.draw_cross(blob.cx(), blob.cy())
            img.draw_keypoints([(blob.cx(), blob.cy(), 
                                 int(math.degrees(blob.rotation())))], size=20)
    print(clock.fps())
```

# 画图

## 1. 画线

```python
image.draw_line(line_tuple, color=White)
```

在图像中画一条直线。
- line_tuple的格式是(x0, y0, x1, y1)，意思是(x0, y0)到(x1, y1)的直线。
- 颜色可以是灰度值(0-255)，或者是彩色值(r, g, b)的元组。默认为白色。

## 2. 画框

```python
image.draw_rectangle(line_tuple, color=White)
```

在图像中画一个矩形框。
- line_tuple的格式是(x0, y0, x1, y1)，意思是(x0, y0)到(x1, y1)的直线。
- 颜色可以是灰度值(0-255)，或者是彩色值(r, g, b)的元组。默认为白色。

## 3. 画圆

```python
image.draw_circle(x, y, radius, color=White) 
```

在图像中画一个圆。
- x,y是圆心坐标
- radius是圆的半径

## 4. 画十字

```python
image.draw_cross(x, y, size=5, color=White) 
```

在图像中画一个十字形状。
- x,y是坐标
- size是十字两侧的尺寸

## 5. 写字符串

```python
image.draw_string(x, y, text, color=White) 
```

从图像(x,y)位置开始，绘制8x10像素的字符串。
- x,y是起始坐标。
- text是要绘制的字符串。可以使用\n, \r, 或 \r\n 移动光标到下一行。

## 6. 示例

```python
import sensor, image, time

sensor.reset()
sensor.set_pixformat(sensor.RGB565)
sensor.set_framesize(sensor.QQVGA)
sensor.skip_frames(10)
while(True):
    img = sensor.snapshot()
    img.draw_line((20, 30, 40, 50))
    img.draw_line((80, 50, 100, 100), color=(255,0,0))
    img.draw_rectangle((20, 30, 41, 51), color=(255,0,0))
    img.draw_circle(50, 50, 30)
    img.draw_cross(90,60,size=10)
    img.draw_string(10,10, "hello world!")
```

## 7. 更多

更多例程请查看 [Drawing](https://developer.canaan-creative.com/canmv/main/canmv/demo/index.html#drawing)

# 扫码

[扫码 — K210 CanMV](https://developer.canaan-creative.com/canmv/main/canmv/get-start/code.html)

#  `AprilTag` 标记追踪

## 1. `AprilTag` 简介

`AprilTag` 是一种高效视觉基准系统，通过普通打印机生成的标签实现高精度3D定位与姿态识别，适用于机器人导航、增强现实及相机校准。其核心优势包括小数据量（4-12位）远距检测、鲁棒的光照与视角适应性，以及基于C语言的无依赖设计，可嵌入低功耗设备实时运行。提供预生成标签库、自定义生成工具及跨平台支持（C/JNI/iOS），开源资源丰富，性能优于ARToolkit等同类技术。

## 2. `AprilTag`

`AprilTag` 的种类叫家族（ `family` ）,有下面的几种：
- TAG16H5 → 0 to 29
- TAG25H7 → 0 to 241
- TAG25H9 → 0 to 34
- TAG36H10 → 0 to 2319
- TAG36H11 → 0 to 586
- ARTOOLKIT → 0 to 511

也就是说 `TAG16H5` 的家族（ `family` ）有30个，每一个都有对应的 id ，从0~29。那么不同的家族，有什么区别呢？ 比如说 `TAG16H5` 的有效区域是 4x4 的方块，那么它比 `TAG36H11` 看的更远（因为他有 6x6 个方块）。但是 `TAG16H5` 的错误率比 `TAG36H11` 高很多，因为 `TAG36H11` 的校验信息多，所以，**如果没有别的理由，推荐使用 `TAG36H11`** 。

## 3. AprilTag 生成

可以通过在线生成网站生成对应 AprilTag，也可以通过 `CanMV IDE` 生成。

在 `CanMV IDE` 中，依次点击 `[工具] -> [机器视觉] -> [AprilTag 生成器]`。推荐选择 “ `TAG36H11` ”。生成之后，可以将其打印出来或者使用屏幕显示（但可能会反光）。

## 4. AprilTag 识别[](https://developer.canaan-creative.com/canmv/main/canmv/get-start/apriltag.html#id4 "Link to this heading")

识别 `AprilTag` 使用函数 [[image-图像处理#2.2.82. `find_apriltags`|find_apriltags]]

对应例程在 [April-Tags](https://developer.canaan-creative.com/canmv/main/canmv/demo/index.html#april-tags)

# 深度学习应用

[深度学习应用 — K210 CanMV](https://developer.canaan-creative.com/canmv/main/canmv/get-start/kpu.html)