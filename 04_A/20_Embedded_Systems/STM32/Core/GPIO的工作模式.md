---
tags:
  - stm32
---

[https://shequ.stmicroelectronics.cn/thread-623010-1-1.html](https://shequ.stmicroelectronics.cn/thread-623010-1-1.html)

([[STM32F103xx参考手册(英文原版).pdf#page=159&selection=12,0,13,17&color=yellow|📖]])
General-purpose and alternate-function I/Os (GPIOs and AFIOs)

# GPIO 基础概念

## 1. GPIO 的定义与作用  

GPIO（通用输入输出）是指**一种通用的数字输入/输出接口，用于与外部电子元件或设备进行通信**。

## 2. STM32 的 GPIO 结构与端口配置  

STM 32 系列 MCU 的 GPIO 内部框图入下所示（对于某个 GPIO 的内部引脚）：
 
![[STM32F103xx参考手册(英文原版).pdf#page=160&rect=124,494,529,741|STM32F103xx参考手册(英文原版), p.160]] ^1

- **Protection diode** (保护二极管)
	- 也叫钳位二极管。
	- IO引脚上下两边两个二极管用于防止引脚外部过高、过低的电压输入。当引脚电压高于VDD时，上方的二极管导通；当引脚电压低于VSS时，下方的二极管导通，防止不正常电压引入芯片导致芯片烧毁。
	- 但是尽管如此，还是不能直接外接大功率器件，须加大功率及隔离电路驱动，防止烧坏芯片或者外接器件无法正常工作。
- **P-MOS / N-MOS**：由P-MOS管和N-MOS管组成的单元电路使得GPIO具有“推挽输出”和“开漏输出”的模式。
- **TTL Schmitt trigger**：信号经过触发器后，模拟信号转化为0和1的数字信号。但是，当GPIO引脚作为ADC采集电压的输入通道时，用其“模拟输入”功能，此时信号不再经过触发器进行TTL电平转换。（可以理解为一个比较器，大于某个值是1，小于某个值是0）

> [!NOTE] 如何避免毛刺的出现？
> ![[STM32F103xx参考手册(英文原版).pdf#page=160&rect=302,631,364,689|STM32F103xx参考手册(英文原版), p.160|150]]
> STM32 的 TTL 施密特触发器通过**迟滞窗口**和**双阈值设计**，确保输入信号必须稳定跨越阈值才会触发逻辑变化，从而有效过滤毛刺和噪声，保证了寄存器的 1 和 0 相对稳定。

^41bd9b

芯片内部寄存器被读为 1 的电压范围：$0.42 * (3.3 - 2) + 1 = 1.546$ V ~ 3.6 V
芯片内部寄存器被读为 0 的电压范围：-0.3 V ~ $0.28 * (3.3 - 2) + 0.8 = 1.164$ V

![[STM32F103xE数据手册.pdf#page=89&rect=67,507,529,648|STM32F103xE数据手册, p.89]] ^8fe992

# GPIO 工作模式分类

## 1. 输入模式  

### 1.1. 浮空输入（Floating Input）  

此模式最常用的是检测按键，可以接收高低电平。但容易被干扰。

![[HAL快速入门与项目实战.pdf#page=52&rect=189,256,413,390|HAL快速入门与项目实战, p.52|500]]

> [!question] 上图的 2 个按键 K 1、K 2，它不被按下时，电平是多少？
> 答案是：不知道！PIN 1、PIN 2 就像一个悬空的电线，它跟参考点“3.3V/GND”没有电气连接，无法确定 PIN 1、PIN 2 的电平是多少。

浮空输入模式下，I/O 端口的电平信号直接进入输入数据寄存器。也就是说，I/O 的电平状态是不确定的，完全由外部输入决定；如果在该引脚悬空（在无信号输入）的情况下，读取该端口的电平是不确定的。

正确的电路如下（PIN 1 增加下拉电阻、PIN 2 增加上拉电阻）：

![[HAL快速入门与项目实战.pdf#page=52&rect=185,72,418,205|HAL快速入门与项目实战, p.52|500]]

$$
\begin{array}{l}
I=\frac{3.3}{R_{1}+R_{2}}=\frac{V}{R_{2}} \\
V=\frac{R_{2}}{R_{1}+R_{2}} \cdot 3.3 \approx 3.3
\end{array}
$$

上图里的下拉电阻、上拉电阻是在芯片外面放置的。芯片内部也可以有上拉、下拉电阻。如需使用可以使能上拉或下拉电阻。

### 1.2. 上拉输入（Pull-Up Input）  

此模式检测到电平默认为高，可以检测到由高到低的电平变化。

### 1.3. 下拉输入（Pull-Down Input）  

此模式检测到电平默认为低，可以检测到由低到高的电平变化。

### 1.4. 模拟输入（Analog Input）  

此模式可以检测外部输入的模拟电压，可以检测电压值，只要不高于Vcc即可。

I/O 端口的模拟信号（电压信号，而非电平信号）直接模拟输入到片上外设模块，比如 ADC 模块等等。

## 2. 输出模式  

### 2.1. 推挽输出（Push-Pull Output）  

推挽输出用于输出高低电平，是最常用的模式。

- 像两个水龙头：一个负责灌水（输出高电平），一个负责抽水（输出低电平）
- 能主动输出强高/低电平，驱动能力强
- 适用场景：直接驱动 LED、普通数字信号输出

### 2.2. 开漏输出（Open-Drain Output）  

开漏输出用于输出低电平，高电平靠外部上拉电阻电压决定，适用于快速切换电压的外部电路结构。

- 只有抽水的水龙头（只能输出低电平），高电平需要外部水管（上拉电阻）
- 防止电平冲突，可实现"线与"功能
- 适用场景： [[08_I2C|I2C]] 总线、电平转换、多设备通信

### 2.3. 复用推挽输出 (Alternate Function Push-Pull)  

其他复用比如 SPI 等可以选择复用推挽输出。

- 推挽模式的升级版，控制权交给芯片内部模块（如 SPI、USART）
- 硬件自动控制高低电平输出
- 适用场景：需要高速输出的外设（如 PWM 输出）

### 2.4. 复用开漏输出 (Alternate Function Open-Drain)  

复用 I2C 时候选择复用开漏输出，因为开漏输出可以“线与”。

- 开漏模式的升级版，同样由芯片内部模块接管控制
- 硬件自动控制低电平输出，高电平仍依赖外部上拉
- 适用场景：需要总线通信的外设（如 I2C）
- ![[STM32F103xx参考手册(英文原版).pdf#page=160&rect=185,512,289,537|STM32F103xx参考手册(英文原版), p.160|300]]

### 2.5. 输出速度配置  

调整 GPIO 端口的输出速率（如 10MHz、2MHz、50MHz）主要用于平衡信号响应速度、功耗和电磁兼容性（EMI）。

![[STM32F103xx参考手册(英文原版).pdf#page=171&rect=60,268,536,621|STM32F103xx参考手册(英文原版), p.171]]

![[STM32F103xx参考手册(英文原版).pdf#page=161&rect=120,443,532,754|STM32F103xx参考手册(英文原版), p.161]]

> [!question] 我该如何将 PA5 配置成输出？
> 1. 将 CNF5 设置成 00 (Push-pull) 或 01 (Open-drain)
> 2. 通过设置 MODE5 调整输出速率
> 
> 	输入也是同理

高速信号易产生辐射干扰，需额外滤波或屏蔽。在满足功能的前提下，尽量使用低速模式以优化功耗和 EMI。  

# 再探 STM32F103 的 GPIO

![[GPIO的工作模式#^1]]

如果我们将一个引脚配置为输出模式时
1. TTL Schmitt trigger 输入被打开（所以在输出模式下也是可以读取 IO 电平的）
2. 内部弱上拉和下拉不会被使能起作用
3. 每隔一个 APB2 时钟周期会采样一次 IO 引脚的电平到数据寄存器
4. **开漏模式下可以通过读取 GPIO 的输入数据寄存器得到 IO 引脚的状态**
5. **在推挽模式下可以通过读取 GPIO 的输出寄存器得到最新输出到 IO 的电平**

推挽输出 PMOS 和 NMOS 都起作用
- 输出数据寄存器写 1，PMOS 导通，IO 电压为 VDD，呈高电平
- 输出数据寄存器写 0，NMOS 导通，IO 电压为 VSS，呈低电平

开漏输出只有 NMOS 起作用
- 输出数据寄存器写 1，NMOS 不导通，IO 为浮空态，电平由外部设备决定
- 输出数据寄存器写 1，NMOS 导通，IO 电压为 VSS，呈低电平

# 相关问题

## 1. 什么是推挽结构和推挽电路

推挽结构一般是指两个参数相同的三极管或MOS管分别受两互补信号的控制，总是在一个三极管或MOS管导通的时候另一个截止。高低电平由输出电平决定。

## 2. 推挽输出和开漏输出的使用场景

- 推挽输出适合单主设备、高速驱动场景，如SPI通信或直接驱动负载
- 开漏输出则用于多设备总线（如I²C）、电平转换和中断共享，通过外部上拉实现灵活性和冲突避免。
- 实际选择需权衡驱动能力、总线拓扑和功耗需求。