---
tags:
  - HAL
deadline: 2025-03-28
---
# ä¸­æ–­æ¦‚å¿µçš„å¼•å…¥

## 1. æŒ‰é”®çš„ä¸¢å¤±

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=58&rect=160,602,445,673|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.58]]

å¦‚æœé€šè¿‡æ­»å¾ªç¯çš„æ–¹å¼è¯»å– GPIO å¼•è„šåˆ¤æ–­æŒ‰é”®çš„çŠ¶æ€ï¼Œå®¹æ˜“ä¸¢å¤±æŒ‰é”®ã€‚æ¯”å¦‚ï¼Œä¸Šå›¾ä¸­å¦‚æœèƒ½åœ¨â‘ â‘¡â‘¢å¤„è¯»å–å¼•è„šçŠ¶æ€ï¼Œå°±èƒ½åˆ¤æ–­å‡ºå¼•è„šè¢«æŒ‰ä¸‹ã€æ¾å¼€ã€‚å¦‚æœç¬¬ 4 æ¬¡è¯»å–æŒ‰é”®æ—¶ï¼Œåˆšå¥½ä½äºä¸Šå›¾â‘£å¤„ï¼Œå°±ä¸¢å¤±äº† 2 ä¸ªæŒ‰é”®åŠ¨ä½œã€‚

## 2. æ—¥å¸¸ç”Ÿæ´»ä¸­æ–­ç¤ºä¾‹

ä½ åœ¨çœ‹ä¹¦ï¼Œé—¨é“ƒå“äº†ï¼šè¿™å°±æ˜¯ä¸€ä¸ªä¸­æ–­ã€‚ä½ ä¼šæ’å…¥ä¹¦ç­¾ï¼ˆä¿å­˜ç°åœºï¼‰ï¼Œå¼€é—¨å–å¿«é€’ï¼ˆå¤„ç†ä¸­æ–­ï¼‰ï¼Œå›æ¥ä»ä¹¦ç­¾ä½ç½®å¤„ç»§ç»­çœ‹ä¹¦ï¼ˆæ¢å¤ç°åœºï¼‰ã€‚

## 3. åµŒå…¥ç³»ç»Ÿä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æƒ…å†µ

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=59&rect=149,644,448,747&color=note|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.59]]

- CPU åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šè¢«å„ç§â€œå¼‚å¸¸â€æ‰“æ–­ã€‚è¿™äº›â€œå¼‚å¸¸â€æœ‰ï¼š
	- æŒ‡ä»¤æœªå®šä¹‰
	- æŒ‡ä»¤ã€æ•°æ®è®¿é—®æœ‰é—®é¢˜
	- SWI (è½¯ä¸­æ–­) 
	- **ä¸­æ–­** - ä¸­æ–­ä¹Ÿå±äºä¸€ç§â€œå¼‚å¸¸â€ï¼Œå¯¼è‡´ä¸­æ–­å‘ç”Ÿçš„æƒ…å†µæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š
		- æŒ‰é”®
		- å®šæ—¶å™¨
		- ADC è½¬æ¢å®Œæˆ
		- UART å‘é€å®Œæ•°æ®ã€æ”¶åˆ°æ•°æ®ç­‰ç­‰

è¿™äº›ä¼—å¤šçš„â€œä¸­æ–­æºâ€ï¼Œæ±‡é›†åˆ°â€œä¸­æ–­æ§åˆ¶å™¨â€ï¼Œç”±â€œä¸­æ–­æ§åˆ¶å™¨â€é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ä¸­æ–­å¹¶é€šçŸ¥ CPUã€‚

## 4. ä¸­æ–­çš„å¤„ç†æµç¨‹

[[Arm èŠ¯ç‰‡å¯¹å¼‚å¸¸ (ä¸­æ–­) å¤„ç†è¿‡ç¨‹]]ï¼š
1. åˆå§‹åŒ–
	- **è®¾ç½®ä¸­æ–­æºï¼Œè®©å®ƒå¯ä»¥äº§ç”Ÿä¸­æ–­**
	- **è®¾ç½®ä¸­æ–­æ§åˆ¶å™¨(å¯ä»¥å±è”½æŸä¸ªä¸­æ–­ï¼Œä¼˜å…ˆçº§)**
	- **è®¾ç½® CPU æ€»å¼€å…³(ä½¿èƒ½ä¸­æ–­)**
2. ç„¶åå°±å¯ä»¥æ‰§è¡Œå…¶ä»–ç¨‹åºäº†ï¼Œæ¯”å¦‚ main å‡½æ•°
3. äº§ç”Ÿä¸­æ–­ï¼šæ¯”å¦‚æŒ‰ä¸‹æŒ‰é”®--->ä¸­æ–­æ§åˆ¶å™¨--->CPU
4. CPU æ¯æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤éƒ½ä¼šæ£€æŸ¥æœ‰æ— ä¸­æ–­/å¼‚å¸¸äº§ç”Ÿ
5. CPU å‘ç°æœ‰ä¸­æ–­/å¼‚å¸¸äº§ç”Ÿï¼Œå¼€å§‹å¤„ç†ã€‚
6. å‘ç”Ÿä¸­æ–­åï¼Œå¯¹äºä¸åŒçš„å¼‚å¸¸ï¼Œè·³å»ä¸åŒçš„åœ°å€æ‰§è¡Œç¨‹åºã€‚

è¿™åœ°å€ä¸Šï¼Œåªæ˜¯ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œè·³å»æ‰§è¡ŒæŸä¸ªå‡½æ•° (åœ°å€)ï¼Œè¿™ä¸ªå°±æ˜¯å¼‚å¸¸å‘é‡ã€‚â‘¢â‘£â‘¤éƒ½æ˜¯ç¡¬ä»¶åšçš„ã€‚

---

è¿™äº›å‡½æ•°åšä»€ä¹ˆäº‹æƒ…ï¼Ÿ 
1. ä¿å­˜ç°åœº (ä¿å­˜è¢«ä¸­æ–­ç¬é—´çš„å„ä¸ªå¯„å­˜å™¨çš„å€¼)
2. å¤„ç†å¼‚å¸¸ (ä¸­æ–­): åˆ†è¾¨ä¸­æ–­æºï¼Œå†è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°
3. æ¢å¤ç°åœºï¼ˆå°±æ˜¯ä»è¢«ä¸­æ–­çš„åœ°æ–¹ç»§ç»­è¿è¡Œï¼‰

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=59&rect=103,84,449,186|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.59]]

# STM32 ä¸­æ–­ä½“ç³»ç»“æ„

å‚è€ƒèµ„æ–™ï¼š

[[../../../../01_P/ARM æ¶æ„/attachments1/Cortex-M3æƒå¨æŒ‡å—(ä¸­æ–‡å‚è€ƒ).pdf]]
## 1. ä¸­æ–­ç»“æ„å›¾

ç»“æ„å›¾å¦‚ä¸‹ï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=60&rect=159,550,461,660|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.60]]

æ²¿ç€ä¸­æ–­ä¿¡å·ä»æºå¤´ï¼ˆæ¯”å¦‚æŸä¸ª GPIO å¼•è„šï¼‰ï¼Œå¦‚ä½•ä¸€è·¯å‘ç»™ CPUï¼Œç®€è¿°å„ä¸ªéƒ¨ä»¶çš„åŠŸèƒ½ï¼š
- **GPIOï¼šå¯ä»¥é…ç½®æŸä¸ªå¼•è„šèƒ½å¦å‘å‡ºä¸­æ–­ä¿¡å·**
	- å¦‚ä¸‹å›¾ï¼ŒPA0~PG0 è¿™å¤šä¸ª 0 å·å¼•è„šä¸­ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªè¿æ¥åˆ° EXTI0ï¼Œå³å®ƒä»¬ä¸­åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªè¢«ç”¨ä½œä¸­æ–­å¼•è„šï¼Œå¯ä»¥åœ¨ AFIO_EXTICR1 å¯„å­˜å™¨ä¸­é€‰æ‹©æŸä¸ªå¼•è„šã€‚![[STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ).pdf#page=210&rect=232,280,392,738|STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ), p.210]]
	- èŠ¯ç‰‡æ‰‹å†Œä¸­æœ‰ AFIO_EXTICR1 å¯„å­˜å™¨çš„æè¿°ï¼š![[STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ).pdf#page=191&rect=64,489,532,753|STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ), p.191]]
- **EXTIï¼šå¯¹å¤–éƒ¨ä¸­æ–­è¿›è¡Œæ›´è¯¦ç»†çš„é…ç½®(è§¦å‘æ–¹å¼ã€ä½¿èƒ½ã€è¯»å–å½“å‰çš„çŠ¶æ€)**
	- EXTI å†…éƒ¨æ¡†å›¾å¦‚ä¸‹ï¼š![[STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ).pdf#page=207&rect=123,144,531,494&color=yellow|ğŸ“–]]
	- è¿˜æ˜¯ä»¥ EXTI0 ä¸ºä¾‹ï¼Œåœ¨ EXTI å†…éƒ¨ï¼Œå¯ä»¥**é…ç½®** EXTI0 çš„ä¸­æ–­**è§¦å‘æ–¹å¼**ï¼ˆä¸Šå‡æ²¿è§¦å‘ã€ä¸‹é™æ²¿è§¦å‘ã€åŒè¾¹æ²¿è§¦å‘ã€è½¯ä»¶è§¦å‘ï¼‰ã€**ä½¿èƒ½**ï¼ˆæ˜¯å¦å…è®¸ EXTI0 ä¼ è¾“åˆ° NVICï¼‰ã€**è¯»å–å®ƒçš„å½“å‰çŠ¶æ€**ï¼ˆæ˜¯å¦æœ‰å¾…å¤„ç†çš„ä¸­æ–­ï¼‰ã€‚
	- å¯„å­˜å™¨å¦‚ä¸‹ï¼š![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=61&rect=164,191,453,304&color=yellow|ğŸ“–]]
- **NVICï¼šç®¡ç†å¤šä¸ªä¸­æ–­æºï¼ˆä½¿èƒ½/å±è”½ã€ä¼˜å…ˆçº§ï¼‰ï¼Œæä¾›â€œ[[#2. å¼‚å¸¸å‘é‡è¡¨|å¼‚å¸¸å‘é‡è¡¨]]â€**
	- åœ¨ NVIC é‡Œï¼Œæ¯ä¸€ä¸ªå¼‚å¸¸ã€ä¸­æ–­ï¼Œéƒ½æœ‰ä¸€ä¸ªç¼–å·ï¼š![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=62&rect=176,441,443,744&color=yellow|ğŸ“–]]
	- å¯¹äºè¿™äº›ä¸­æ–­ï¼Œéƒ½å¯ä»¥å•ç‹¬è®¾ç½®ï¼š
		1. **ä½¿èƒ½/å±è”½**ï¼šæ˜¯å¦å…è®¸å®ƒä¼ è¾“åˆ° CPU
		2. **ä¼˜å…ˆçº§**
	- å½“å„ç±»ä¸­æ–­è¿›å…¥ NVIC åï¼ŒNVIC é‡Œè¿˜æœ‰å¼€å…³ï¼Œè¿™äº›ä¸­æ–­èƒ½å¦å‘ç»™ CPUï¼Ÿå‡è®¾æœ‰äº›ä¸­æ–­æ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼Œå“ªä¸€ä¸ªèƒ½ä¼˜å…ˆä¼ ç»™ CPUï¼Ÿ
	- åœ¨ NVIC é‡Œï¼Œå¯ä»¥è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§ã€ä¸­æ–­å‘é‡è¡¨ï¼ˆå½“å‘ç”Ÿä¸­æ–­æ—¶ï¼Œå»è¿™ä¸ªè¡¨é‡Œæ‰¾åˆ°ã€è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼‰ã€‚
	- NVIC é‡Œä½¿èƒ½ä¸­æ–­çš„å¯„å­˜å™¨å¦‚ä¸‹ï¼ˆä¼˜å…ˆçº§ç›¸å…³å¯„å­˜å™¨çœ‹åé¢ï¼‰ï¼š![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=63&rect=151,499,470,769&color=yellow|ğŸ“–]]
- **CPUï¼šCPUå†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ªå¼€å…³ï¼Œæ˜¯å¦ä½¿èƒ½CPUå¤„ç†ä¸­æ–­**
	- CPU å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªâ€œPRIMASKâ€å¯„å­˜å™¨ï¼Œâ€œPriority maskâ€ï¼Œå¾€å®ƒå†™å…¥ 1 å¯ä»¥ç¦æ­¢æ‰€æœ‰ä¸­æ–­ï¼›å¾€å®ƒå†™å…¥ 0ï¼Œå¯ä»¥ä½¿èƒ½ä¸­æ–­ [[#2.3. è®¾ç½® CPU]]ã€‚ä»£ç å¦‚ä¸‹ï¼š
	- ![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=63&rect=138,337,459,455|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.63]]
	- å¦‚æœè¿˜æƒ³ç²¾ç¡®åœ°ç¦æ­¢â€œä¼˜å…ˆçº§ä½äºæŸä¸ªæ•°å€¼â€çš„é‚£äº›ä¸­æ–­ï¼Œå¯ä»¥ä½¿ç”¨â€œBASEPRIâ€ã€‚æ¯”å¦‚æƒ³ç¦æ­¢â€œä¼˜å…ˆçº§æ•°å€¼å¤§äºç­‰äº 0x60 çš„æ‰€æœ‰å¼‚å¸¸â€ï¼Œå¯ä»¥æŠŠ 0x60 å†™å…¥ BASEPRI å¯„å­˜å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
		```
		: å±è”½ä¼˜å…ˆçº§ä¸º0x60~0xFFçš„å¼‚å¸¸
		MOVS R0, #0x60
		MSR BASEPRI, R0
		
		: å–æ¶ˆå±è”½
		MOVS R0, #0
		MSR BASEPRI, R0
		```

å½“â‘ â‘¡â‘¢â‘£å„éƒ¨ä»¶éƒ½è®¾ç½®ã€ä½¿èƒ½å¥½äº†ä¹‹åï¼ŒæŸä¸ªä¸­æ–­å‘ç”Ÿäº†ï¼Œæ¯”å¦‚ PA0 çš„ç”µå¹³ä»é«˜å˜ä½äº†ï¼Œå°±ä¼šè§¦å‘ä¸­æ–­ã€‚CPU æ¥æ”¶åˆ°ä¸­æ–­åï¼Œå°±ä¼šè·³è½¬åˆ° NVIC ä¸­è®¾ç½®çš„â€œå¼‚å¸¸å‘é‡è¡¨â€ï¼Œæ ¹æ® EXTI0 çš„ ID æ‰¾åˆ°è¡¨é‡Œå¯¹åº”çš„å‡½æ•°ï¼Œæ‰§è¡Œå®ƒã€‚

## 2. å¼‚å¸¸å‘é‡è¡¨

åœ¨ä¸­ `startup_stm32f103xe.s`ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=64&rect=154,456,450,726&color=yellow|ğŸ“–]]

éœ€è¦æŠŠè¿™ä¸ªè¡¨æ ¼çš„åŸºåœ°å€å³ `__Vectors` å‘Šè¯‰ NVICï¼Œè¿™æ ·ï¼šå½“ CPU æ£€æµ‹åˆ°å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ‰ä¼šæ ¹æ®å¼‚å¸¸ ID åœ¨è¿™ä¸ªè¡¨æ ¼é‡Œæ‰¾åˆ°å¹¶æ‰§è¡Œå¯¹åº”å‡½æ•°ã€‚ 

## 3. ä¸­æ–­ä¼˜å…ˆçº§

åœ¨ NVIC é‡Œï¼Œå¯¹äºæ¯ä¸€ä¸ªä¸­æ–­ï¼Œéƒ½æœ‰ä¸€ä¸ª 8 ä½çš„å¯„å­˜å™¨è¢«ç”¨æ¥è¡¨ç¤ºå®ƒçš„ä¼˜å…ˆçº§ã€‚è¿™ä¸ª 8 ä½çš„å¯„å­˜å™¨ï¼Œè¢«åˆ†ä¸º 2 éƒ¨åˆ†ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼šåˆ†ç»„ä¼˜å…ˆçº§ï¼ˆä¹Ÿå«æŠ¢å ä¼˜å…ˆçº§ï¼‰ã€å­ä¼˜å…ˆçº§ã€‚

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=64&rect=103,240,503,340|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.64]]

- **åˆ†ç»„ä¼˜å…ˆçº§ï¼ˆæŠ¢å ä¼˜å…ˆçº§ï¼‰** è¢«ç”¨æ¥åˆ¤æ–­ï¼šå½“å‰æ­£åœ¨å¤„ç†çš„ä¸­æ–­ï¼Œ**èƒ½å¦è¢«æ‰“æ–­**ã€‚æ¯”å¦‚å½“å‰æ­£åœ¨å¤„ç† EXT0 ä¸­æ–­ï¼Œå®ƒçš„åˆ†ç»„ä¼˜å…ˆçº§ä¸º 3ï¼›å¦‚æœè¿™æ—¶å€™å‘ç”Ÿäº† EXT1 ä¸­æ–­ï¼Œå®ƒçš„åˆ†ç»„ä¼˜å…ˆçº§ä¸º 4ï¼ˆæ•°å€¼è¶Šé«˜ï¼Œä¼˜å…ˆçº§è¶Šä½ï¼‰ï¼Œé‚£ä¹ˆ EXT1 çš„ä¸­æ–­å°±æ— æ³•æ‰“æ–­ EXT0ï¼Œç­‰ EXT0 çš„ä¸­æ–­å¤„ç†å®Œæ¯•ï¼ŒEXT1 çš„ä¸­æ–­æ‰èƒ½è¢«å¤„ç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœ EXT1 çš„åˆ†ç»„ä¼˜å…ˆçº§ä¸º 2ï¼Œé‚£ä¹ˆå½“å‰çš„ EXT0 ä¸­æ–­å°±è¢«â€œæŠ¢å â€ï¼Œå…ˆæ‰§è¡Œ EXT1 çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œå†ç»§ç»­æ‰§è¡Œâ€œè¢«æŠ¢å çš„ EXT0â€ä¸­æ–­å‡½æ•°ã€‚
- **å­ä¼˜å…ˆçº§** è¢«ç”¨æ¥åˆ¤æ–­ï¼šä¸¤ä¸ªä¸­æ–­åŒæ—¶å‘ç”Ÿæ—¶ï¼Œ**è°å…ˆè¢«å¤„ç†**ã€‚è¿˜æ˜¯ä»¥ EXT0ã€EXT1 ä¸ºä¾‹ï¼Œå¦‚æœå®ƒä»¬åŒæ—¶å‘ç”Ÿäº†ï¼Œé‚£ä¹ˆåˆ†ç»„ä¼˜å…ˆçº§é«˜çš„ä¸­æ–­å…ˆè¢«å¤„ç†ï¼›å¦‚æœåˆ†ç»„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå­ä¼˜å…ˆçº§é«˜çš„å…ˆè¢«å¤„ç†ï¼›å¦‚æœè¿å­ä¼˜å…ˆçº§ä¹Ÿç›¸åŒï¼Œé‚£ä¹ˆç¼–å·å°çš„ EXT0 å…ˆè¢«å¤„ç†ã€‚

> [!warning] æ³¨æ„
> å¦‚æœ EXT0ã€EXT1 çš„åˆ†ç»„ä¼˜å…ˆçº§ç›¸åŒï¼Œæ˜¯ä¸ä¼šå‘ç”Ÿâ€œæŠ¢å â€çš„ã€‚æ¯”å¦‚ EXT0 ä¸­æ–­æ­£åœ¨è¢«å¤„ç†ï¼ŒEXT1 ç´§æ¥ç€è¢«è§¦å‘äº†ï¼Œå³ä½¿ EXT1 çš„å­ä¼˜å…ˆçº§é«˜äº EXT0ï¼ŒEXT1 ä¹Ÿä¸ä¼šæŠ¢å  EXI0ã€‚å½“ EXT0 è¢«å¤„ç†å®Œæ¯•ï¼Œæ‰è½®åˆ° EXT1 è¢«å¤„ç†ã€‚

é‚£ä¹ˆï¼Œåœ¨æ¯ä¸ªä¸­æ–­çš„ 8 ä½ä¼˜å…ˆçº§çŠ¶æ€å¯„å­˜å™¨é‡Œï¼Œæœ‰ 2 ä¸ªé—®é¢˜ï¼š

> [!question] è¿™ 8 ä½éƒ½å®ç°äº†å—ï¼Ÿ
> ä¸ä¸€å®šï¼Œæ¯”å¦‚ STM32F103 ç³»åˆ—èŠ¯ç‰‡é‡Œåªå®ç°äº† 4 ä½ã€‚å®ç°è¶Šå¤šä½æ•°ï¼Œç¡¬ä»¶è®¾è®¡è¶Šå¤æ‚ï¼Œ åŠŸè€—è¶Šé«˜ã€‚å®ç°å¤šå°‘ä½ï¼Œè¿™æ˜¯ç”±èŠ¯ç‰‡å…¬å¸å†³å®šçš„ã€‚

> [!question] è¿™ 8 ä½é‡Œï¼Œå“ªå‡ ä½è¡¨ç¤ºåˆ†ç»„ä¼˜å…ˆçº§ï¼ˆå‰©ä¸‹çš„å°±è¡¨ç¤ºå­ä¼˜å…ˆçº§ï¼‰ï¼Ÿ
> è¿™æ˜¯å¯é…ç½®çš„ï¼ŒNVIC å†…éƒ¨æœ‰ä¸€ä¸ªâ€œä¼˜å…ˆçº§åˆ†ç»„çš„é…ç½®å¯„å­˜å™¨â€ï¼Œé€šè¿‡å®ƒå¯ä»¥è®¾ç½®æ‰€æœ‰ä¸­æ–­çš„â€œ8 ä½ä¼˜å…ˆçº§å¯„å­˜å™¨é‡Œï¼Œå“ªå‡ ä½è¡¨ç¤ºåˆ†ç»„ä¼˜å…ˆçº§â€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
> ![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=65&rect=114,531,495,662|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.65]]

# GPIO ä¸­æ–­ç¼–ç¨‹

## 1. ç¼–ç¨‹ç¤ºä¾‹

[[04_A/STM32/åŸç†å›¾/DshanMCU-F103_baseboard.pdf|åŸç†å›¾]]

## 2. HAL åº“ä»£ç è§£æ

è§£è¯»æºç ï¼šâ€œ0601_key_isrâ€

### 2.1. è®¾ç½® GPIO å’Œ EXTI

åœ¨ `Core\Src\gpio. C` çš„â€œMX_GPIO_Initâ€å‡½æ•°ä¸­ï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š

```c
/*Configure GPIO pin : PB14 */
GPIO_InitStruct.Pin = GPIO_PIN_14;
GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING_FALLING;
GPIO_InitStruct.Pull = GPIO_NOPULL;
HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);
```

è™½ç„¶ `HAL_GPIO_Init` ä»¥ GPIO å‘½åï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ä»£ç é‡Œï¼Œè¿˜æ˜¯ä¼šè®¾ç½®â€œGPIOâ€æ¨¡å—é€‰æ‹©æŠŠ PB14 è¿æ¥åˆ° EXTI14ï¼Œè®¾ç½® EXTI14 çš„ä¸­æ–­è§¦å‘æ–¹å¼ä¸ºâ€œåŒè¾¹æ²¿â€ã€‚

![[STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ).pdf#page=192&rect=61,220,531,484|STM32F103xxå‚è€ƒæ‰‹å†Œ(è‹±æ–‡åŸç‰ˆ), p.192]]

### 2.2. è®¾ç½® NVIC

```c
/* EXTI interrupt init*/
HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);
```

```c
HAL_StatusTypeDef HAL_Init(void)
{
  /* Configure Flash prefetch */
#if (PREFETCH_ENABLE != 0)
#if defined(STM32F101x6) || defined(STM32F101xB) || defined(STM32F101xE) || defined(STM32F101xG) || \
    defined(STM32F102x6) || defined(STM32F102xB) || \
    defined(STM32F103x6) || defined(STM32F103xB) || defined(STM32F103xE) || defined(STM32F103xG) || \
    defined(STM32F105xC) || defined(STM32F107xC)

  /* Prefetch buffer is not available on value line devices */
  __HAL_FLASH_PREFETCH_BUFFER_ENABLE();
#endif
#endif /* PREFETCH_ENABLE */

  /* Set Interrupt Group Priority */
  HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_4);
```

å¯¹äºå‰é¢çš„ EXTI0... å¯ä»¥ç›´æ¥å‘ç»™ CPU ï¼Œä¸ºäº†èŠ‚çº¦ç¡¬ä»¶èµ„æºï¼Œå°† EXTI10~EXTI15 å…± 6 ä¸ªä¸­æ–­åˆå¹¶ä¸ºä¸€ä¸ªï¼Œå‘ç»™ NVICã€‚

æ‰€ä»¥ä¸Šè¿°ä»£è®¾ç½®çš„ä¸­æ–­ä¸º  `EXTI15_10_IRQn` ï¼šè®¾ç½®å®ƒçš„ä¼˜å…ˆçº§ã€ä½¿èƒ½å®ƒï¼ˆèƒ½å¤Ÿå‘ç»™ CPUï¼‰ã€‚

å‘é‡è¡¨åˆ™æ˜¯ä½¿ç”¨é»˜è®¤çš„å€¼

### 2.3. è®¾ç½® CPU

æ— éœ€é…ç½® CPUï¼Œå¯ä»¥ä½¿ç”¨è°ƒè¯•å·¥å…·æŸ¥çœ‹ CPU å¯„å­˜å™¨ï¼Œå‘ç°å®ƒé»˜è®¤ä½¿èƒ½äº†ä¸­æ–­å¤„ç†ï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=66&rect=236,207,384,440|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.66]]

# ä½¿ç”¨ OLED è¿›è¡Œè°ƒè¯•

æœ¬èŠ‚ç¨‹åºæºç ä¸ºâ€œ0602_key_isr_oledâ€ï¼Œåœ¨â€œ0601_key_isrâ€çš„åŸºç¡€ä¸Šä¿®æ”¹å¾—æ¥ã€‚

![[04_A/STM32/åŸç†å›¾/DshanMCU-F103_baseboard.pdf#page=1&rect=38,243,192,321|DshanMCU-F103_baseboard, p.1]]

## 1. STM32CuMX é…ç½®

OLED å±å¹•ä½¿ç”¨ I2C1 é€šé“ï¼ŒI2C1 ä½¿ç”¨ PB6ã€PB7 ä½œä¸º SCLã€SDA å¼•è„šï¼Œé…ç½®å¦‚ä¸‹ï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=68&rect=110,514,487,733|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.68]]

## 2. ä¸Šæœºæµ‹è¯•

è¿™é‡Œä½¿ç”¨åˆ°çš„é©±åŠ¨ä»¥åŠæµ‹è¯•ä»£ç ä½äº `Drivers/DShanMCU-F103/driver_oled. C` å’Œ â€œDrivers/DShanMCU-F103/driver_oled. Hâ€ ä¸­ã€‚æŠŠâ€œDShanMCU-F103 å¼€å‘æ¿èµ„æ–™\5_ç¨‹åºæºç \01_å•ç‰‡æœºç¨‹åº\03_å‚è€ƒçš„æºç \DshanMCU-F103\01_nwatch_game. 7zâ€è§£å‹å¼€ï¼ŒæŠŠé‡Œé¢ `Drivers/DShanMCU-F103/driver_oled. C` å’Œ `Drivers/DShanMCU-F103/driver_oled. H` åŠ å…¥å·¥ç¨‹ã€‚

å…¶ä¸­ï¼ŒOLED_Test å‡½æ•°å®Œæˆäº† OLED å±å¹•çš„åˆå§‹åŒ–ä¸æµ‹è¯•å·¥ä½œã€‚

## 3. å‡½æ•°è¯´æ˜

OLED çš„åˆ†è¾¨ç‡æ˜¯ `128*64`ï¼Œè¦æ˜¾ç¤º `8*16` ç‚¹é˜µå­—ç¬¦æ—¶ï¼Œæ¯è¡Œæœ€å¤šå¯ä»¥æ˜¾ç¤º 16 ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ä¸‹é¢ç½—åˆ—çš„å‡½æ•°é‡Œï¼Œ**X åæ ‡çš„å–å€¼ä¸º 0~15**ã€‚æœ€å¤šåŒæ—¶èƒ½æ˜¾ç¤º 4 è¡Œå­—ç¬¦ï¼ŒæŒ‰ç†è¯´ Y åæ ‡å–å€¼åº”è¯¥ä¸º 0~3ï¼Œä½†æ˜¯ä¸ºäº†æ›´ç»†è‡´åœ°è°ƒæ•´å­—ç¬¦çš„ Y åæ ‡ï¼Œæˆ‘ä»¬æŠŠ **Y åæ ‡çš„å–å€¼èŒƒå›´è®¾å®šä¸º 0~7**ã€‚

ä¸‹å›¾é‡Œï¼Œåˆ†åˆ«åœ¨åæ ‡ (0, 0)ã€(0,1) ä½ç½®æ˜¾ç¤ºäº†å­—ç¬¦â€œAâ€ï¼›åœ¨åæ ‡()æ˜¾ç¤ºäº†å­—ç¬¦â€œBâ€ï¼›åœ¨åæ ‡ï¼ˆ0,4ï¼‰ã€ï¼ˆ0,5ï¼‰æ˜¾ç¤ºäº†å­—ç¬¦â€œCâ€ï¼›åœ¨åæ ‡ï¼ˆ0,6ï¼‰æ˜¾ç¤ºäº†å­—ç¬¦â€œDâ€ã€‚

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=68&rect=202,80,414,270|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.68]]

---

OLED åˆå§‹åŒ–ï¼š

```c
void OLED_Init(void);
```

æ¸…é™¤å±å¹•ï¼ˆæŠŠå±å¹•å…¨éƒ¨æ˜¾ç¤ºä¸ºé»‘è‰²ï¼‰ï¼š

```c
 void OLED_Clear(void);
```

åœ¨å±å¹•ä¸ŠæŒ‡å®šä½ç½®æ˜¾ç¤º ASCII å­—ç¬¦ï¼š

```c
/*
 * è¾“å…¥å‚æ•°ï¼šx --> xåæ ‡(0~15)
 * y --> yåæ ‡(0~7)
 * c --> æ˜¾ç¤ºçš„å­—ç¬¦
*/
void OLED_PutChar(uint8_t x, uint8_t y, char c);
```

åœ¨å±å¹•ä¸ŠæŒ‡å®šä½ç½®æ˜¾ç¤ºå­—ç¬¦ä¸²ï¼š

```c
/*
 * è¾“å…¥å‚æ•°ï¼šx --> xåæ ‡(0~15)
 * y --> yåæ ‡(0~7)
 * str --> æ˜¾ç¤ºçš„å­—ç¬¦
*/
int OLED_PrintString(uint8_t x, uint8_t y, const char *str);
```

ä»å±å¹•ä¸ŠæŒ‡å®šä½ç½®æ¸…é™¤ä¸€è¡Œï¼š

```c
/*
 * è¾“å…¥å‚æ•°ï¼šx - ä»è¿™é‡Œå¼€å§‹
 * y - æ¸…é™¤è¿™è¡Œ
*/
void OLED_ClearLine(uint8_t x, uint8_t y);
```

[[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=70&selection=42,0,47,7&color=note|ğŸ“–]]

# æŒ‰é”®é©±åŠ¨ç¨‹åºæ”¹è¿›

## 1. ä½¿ç”¨å®šæ—¶å™¨æ¶ˆé™¤æŠ–åŠ¨

> æœ¬èŠ‚ç¨‹åºæºç ä¸ºâ€œ0603_key_timerâ€ï¼Œåœ¨â€œ0602_key_isr_oledâ€çš„åŸºç¡€ä¸Šä¿®æ”¹å¾—æ¥ã€‚

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=72&rect=152,453,443,681|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.72]]

åœ¨å®é™…çš„æŒ‰é”®æ“ä½œä¸­ï¼Œå¯èƒ½ä¼šæœ‰æœºæ¢°æŠ–åŠ¨ã€‚æŒ‰ä¸‹æˆ–æ¾å¼€ä¸€ä¸ªæŒ‰é”®ï¼Œå®ƒçš„ GPIO ç”µå¹³ä¼šåå¤å˜åŒ–ï¼Œæœ€åæ‰ç¨³å®šã€‚ä¸€èˆ¬æ˜¯ 5~10 æ¯«ç§’æ‰ä¼šç¨³å®šã€‚

> [!question] å¦‚æœä¸å¤„ç†æŠ–åŠ¨çš„è¯ï¼Œç”¨æˆ·åªæ“ä½œä¸€æ¬¡æŒ‰é”®ï¼Œä¸­æ–­ç¨‹åºå¯èƒ½ä¼šä¸ŠæŠ¥å¤šä¸ªæ•°æ®ã€‚æ€ä¹ˆå¤„ç†ï¼Ÿ
> 1. åœ¨æŒ‰é”®ä¸­æ–­ç¨‹åºä¸­ï¼Œå¯ä»¥å¾ªç¯åˆ¤æ–­å‡ åäº³ç§’ï¼Œå‘ç°ç”µå¹³ç¨³å®šä¹‹åå†ä¸ŠæŠ¥
> 2. ä½¿ç”¨å®šæ—¶å™¨

æ˜¾ç„¶ç¬¬ 1 ç§æ–¹æ³•å¤ªè€—æ—¶ï¼Œè¿èƒŒâ€œä¸­æ–­è¦å°½å¿«å¤„ç†â€çš„åŸåˆ™ï¼Œä½ çš„ç³»ç»Ÿä¼šå¾ˆå¡ã€‚æ€ä¹ˆä½¿ç”¨å®šæ—¶å™¨ï¼Ÿçœ‹ä¸‹å›¾ï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=72&rect=117,131,480,343|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.72]]

> [!NOTE] æ ¸å¿ƒåœ¨äºï¼š
> åœ¨ GPIO ä¸­æ–­ä¸­å¹¶ä¸ç«‹åˆ»è®°å½•æŒ‰é”®å€¼ï¼Œè€Œæ˜¯ä¿®æ”¹å®šæ—¶å™¨è¶…æ—¶æ—¶é—´ï¼Œ10ms åå†å¤„ç†ã€‚å¦‚æœ 10ms å†…åˆå‘ç”Ÿäº† GPIO ä¸­æ–­ï¼Œé‚£å°±è®¤ä¸ºæ˜¯æŠ–åŠ¨ï¼Œè¿™æ—¶å†æ¬¡ä¿®æ”¹è¶…æ—¶æ—¶é—´ä¸º 10msã€‚

åªæœ‰ 10ms ä¹‹å†…å†æ—  GPIO ä¸­æ–­å‘ç”Ÿï¼Œé‚£ä¹ˆå®šæ—¶å™¨çš„å‡½æ•°æ‰ä¼šè¢«è°ƒç”¨ã€‚åœ¨å®šæ—¶å™¨å‡½æ•°ä¸­è®°å½•æŒ‰é”®å€¼ã€‚

---

### 1.1. ä½¿ç”¨å®šæ—¶å™¨æ¶ˆé™¤æŠ–åŠ¨ç¨‹åºæµç¨‹

#### 1.1.1. Â ç³»ç»Ÿé—¹é’Ÿ

- â€‹ä½œç”¨ï¼šæ¯æ¯«ç§’å“ä¸€æ¬¡ï¼Œæé†’ä¸»å¨è¯¥æ£€æŸ¥æ‰€æœ‰æ­£åœ¨å€’è®¡æ—¶çš„ä»»åŠ¡äº†ã€‚
- â€‹ä»£ç å¯¹åº”ï¼š
    ```c
    // ç³»ç»Ÿå®šæ—¶å™¨ä¸­æ–­å‡½æ•°ï¼ˆåœ¨ stm32f1xx_it.cï¼‰
    void SysTick_Handler(void) {
        HAL_IncTick();                // æ›´æ–°ç³»ç»Ÿæ—¶é—´ï¼ˆç±»ä¼¼å¨æˆ¿çš„æ—¶é’Ÿå¾€å‰èµ°ï¼‰
        check_timer();                // æ£€æŸ¥æ‰€æœ‰è½¯ä»¶å®šæ—¶å™¨æ˜¯å¦è¶…æ—¶
    }
    ```

#### 1.1.2. è½¯ä»¶å®šæ—¶å™¨

è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å€’è®¡æ—¶å™¨ï¼Œç”¨æ¥è®°å½•æŸä¸ªä»»åŠ¡éœ€è¦å¤šä¹…åæ‰§è¡Œã€‚æ¯”å¦‚ï¼šâ€œ10æ¯«ç§’åæé†’ä¸»å¨å…³ç«â€ã€‚
- â€‹ç»“æ„ä½“å®šä¹‰ï¼š
    ```c
    struct soft_timer {
        uint32_t timeout;  // å®šæ—¶å™¨è¶…æ—¶æ—¶é—´ï¼ˆä¾‹å¦‚ï¼šå½“å‰æ—¶é—´ + 10æ¯«ç§’ï¼‰
        void *args;        // ä»»åŠ¡å‚æ•°ï¼ˆæ¯”å¦‚è¦å…³å“ªä¸ªç¶å°ï¼‰
        void (*func)(void *); // è¶…æ—¶åè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆæ¯”å¦‚å…³ç«å‡½æ•°ï¼‰
    };
    ```

#### 1.1.3. é—¨é“ƒæŒ‰é”®ï¼ˆGPIOä¸­æ–­ï¼‰â€‹

- â€‹ä½œç”¨ï¼šå½“æœ‰äººæŒ‰é—¨é“ƒï¼ˆæ¯”å¦‚æŒ‰ä¸‹æŒ‰é”®ï¼‰ï¼Œè§¦å‘ä¸€ä¸ªä¸­æ–­ï¼Œä¸»å¨ç«‹åˆ»åœä¸‹æ‰‹å¤´å·¥ä½œå»å¤„ç†ã€‚
- â€‹ä»£ç å¯¹åº”ï¼š
    ```c
    // æŒ‰é”®ä¸­æ–­å›è°ƒå‡½æ•°ï¼ˆåœ¨ main.cï¼‰
    void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
        if (GPIO_Pin == GPIO_PIN_14) {
            mod_timer(&key_timer, 10); // å¯åŠ¨ä¸€ä¸ª10æ¯«ç§’çš„å®šæ—¶å™¨
        }
    }
    ```

#### 1.1.4. å®šæ—¶å™¨å¦‚ä½•å·¥ä½œï¼Ÿ

##### 1.1.4.1. å¯åŠ¨å®šæ—¶å™¨

æŒ‰ä¸‹æŒ‰é”®åï¼Œè°ƒç”¨Â `mod_timer`Â è®¾ç½®å®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´ï¼š

```c
void mod_timer(struct soft_timer *pTimer, uint32_t timeout) {
    pTimer->timeout = HAL_GetTick() + timeout; // å½“å‰æ—¶é—´ + 10ms
}
```

##### 1.1.4.2. æ£€æŸ¥å®šæ—¶å™¨

ç³»ç»Ÿé—¹é’Ÿæ¯æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡å®šæ—¶å™¨æ˜¯å¦è¶…æ—¶ï¼š

```c
void check_timer(void) {
    if (key_timer.timeout <= HAL_GetTick()) {
        key_timer.func(key_timer.args); // è¶…æ—¶åæ‰§è¡Œä»»åŠ¡ï¼ˆæ¯”å¦‚g_key_cnt++ï¼‰
    }
}
```

##### 1.1.4.3. â€‹æ‰§è¡Œä»»åŠ¡

è¶…æ—¶åï¼Œä¸»å¨æ‰§è¡ŒÂ `key_timerout_func`ï¼š

```c
void key_timerout_func(void *args) {
    g_key_cnt++;       // è®°å½•æŒ‰é”®æŒ‰ä¸‹çš„æ¬¡æ•°
    key_timer.timeout = ~0; // é‡ç½®å®šæ—¶å™¨ï¼ˆ~0è¡¨ç¤ºåœæ­¢ï¼‰
}
```

#### 1.1.5. â€‹æ˜¾ç¤ºç»“æœï¼šOLEDå±å¹•

ä¸»å¨æ¯æ¬¡æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä¼šåœ¨å°é»‘æ¿ä¸Šæ›´æ–°æŒ‰é”®æŒ‰ä¸‹çš„æ¬¡æ•°ï¼š

```c
// ä¸»å¾ªç¯ï¼ˆåœ¨ main.cï¼‰
while (1) {
    OLED_PrintSignedVal(0, 6, g_key_cnt); // æ˜¾ç¤ºæŒ‰é”®æ¬¡æ•°
}
```

## 2. ç¯å½¢ç¼“å†²åŒºçš„æ¦‚å¿µ

å³ä½¿ä½¿ç”¨ä¸­æ–­å‡½æ•°æˆ–è€…å®šæ—¶å™¨å‡½æ•°è®°å½•æŒ‰é”®ï¼Œå¦‚æœåªèƒ½è®°å½•ä¸€ä¸ªé”®å€¼çš„è¯ï¼Œä¸èƒ½åŠæ—¶è¯»å‡ºæ¥ï¼Œå†æ¬¡å‘ç”Ÿä¸­æ–­æ—¶æ–°å€¼å°±ä¼šè¦†ç›–æ—§å€¼ã€‚è¦è§£å†³æ•°æ®è¢«è¦†ç›–çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç¨å¾®å¤§ç‚¹çš„ç¼“å†²åŒºï¼Œè¿™å°±æ¶‰åŠæ•°æ®çš„å†™å…¥ã€è¯»å‡ºã€‚å¯ä»¥ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºã€‚

ç¯å½¢ç¼“å†²åŒºç‰¹åˆ«é€‚åˆè¿™ç§åœºæ™¯ï¼š
- ä¸€æ–¹å†™ buffer
- å¦ä¸€æ–¹è¯» buffer

ç¯å½¢ç¼“å†²åŒºå®é™…ä¸Šè¿˜æ˜¯ä¸€ç»´æ•°ç»„ï¼Œå‡è®¾æœ‰ N ä¸ªæ•°ç»„é¡¹ï¼Œä»ç¬¬ 0 ä¸ªæ•°ç»„é¡¹å¼€å§‹éå†ï¼Œè®¿é—®å®Œç¬¬ N-1 ä¸ªæ•°ç»„é¡¹åï¼Œå†ä» 0 å¼€å§‹â€”â€”è¿™å°±æ˜¯â€œç¯å½¢â€çš„å«ä¹‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=73&rect=234,509,359,608|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.73]]

ç¯å½¢ç¼“å†²åŒºçš„å·¥ä½œåŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![[HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜.pdf#page=73&rect=145,181,447,497|HALå¿«é€Ÿå…¥é—¨ä¸é¡¹ç›®å®æˆ˜, p.73]]

1. æœ‰è¯»ä½ç½®ã€å†™ä½ç½®ï¼šrã€wï¼Œå®ƒä»¬è¡¨ç¤ºâ€œä¸‹ä¸€ä¸ªè¦è¯»çš„ä½ç½®â€ã€â€œä¸‹ä¸€ä¸ªè¦å†™çš„ä½ç½®â€ã€‚åˆå§‹å€¼éƒ½æ˜¯ 0ã€‚
2. å†™æ•°æ®æ—¶ï¼šæŠŠæ•°æ®å†™å…¥ `buffer[w]` ï¼Œç„¶åè°ƒæ•´ w æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆå½“ w è¶Šç•Œåè¦ä» 0 å¼€å§‹ï¼‰ã€‚
3. è¯»æ•°æ®æ—¶ï¼šä» `buffer[r]` è¯»å‡ºæ•°æ®ï¼Œç„¶åè°ƒæ•´ r æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆå½“ r è¶Šç•Œåè¦ä» 0 å¼€å§‹ï¼‰ã€‚
4. **åˆ¤æ–­ buffer ä¸ºç©ºï¼šr ç­‰äº w æ—¶è¡¨ç¤ºç©º**ï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥å†™æˆå½“ `buffer[r] != buffer[w]` æ—¶ï¼Œbuffer ä¸ä¸ºç©ºï¼Œå¯ä»¥è¯»æ•°æ®
5. **åˆ¤æ–­ buffer ä¸ºæ»¡ï¼šâ€œä¸‹ä¸€ä¸ªå†™ä½ç½®â€ç­‰äºå½“å‰è¯»ä½ç½®**ï¼Œï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥å†™æˆ

## 3. ç¯å½¢ç¼“å†²åŒºçš„ç¼–ç¨‹

æœ¬èŠ‚ç¨‹åºæºç ä¸ºâ€œ0604_key_circle_bufferâ€ï¼Œåœ¨â€œ0603_key_timerâ€çš„åŸºç¡€ä¸Šä¿®æ”¹å¾—æ¥ã€‚

```c
/* ------  circle_buffer.h  ------ */

#ifndef _CIRCLE_BUF_H
#define _CIRCLE_BUF_H

#include <stdint.h>

typedef struct circle_buf {
	uint32_t r;
	uint32_t w;
	uint32_t len;
	uint8_t *buf;
} circle_buf, *p_circle_buf;

void circle_buf_init(p_circle_buf pCircleBuf, uint32_t len, uint8_t *buf);

int circle_buf_read(p_circle_buf pCircleBuf, uint8_t *pVal);

int circle_buf_write(p_circle_buf pCircleBuf, uint8_t val);

#endif /* _CIRCLE_BUF_H */

```

```c
/* ------  circle_buffer.c  ------ */

#include "circle_buffer.h"

void circle_buf_init(p_circle_buf pCircleBuf, uint32_t len, uint8_t *buf)
{
	pCircleBuf->r = pCircleBuf->w = 0;
	pCircleBuf->len = len;
	pCircleBuf->buf = buf;
}

int circle_buf_read(p_circle_buf pCircleBuf, uint8_t *pVal)
{
	if(pCircleBuf->w != pCircleBuf->r)
	{
		*pVal = pCircleBuf->buf[pCircleBuf->r];
		
		pCircleBuf->r++;
		
		if (pCircleBuf->r == pCircleBuf->len)
			pCircleBuf->r = 0;
		return 0;
	}
	else
	{
		return -1;
	}
}

int circle_buf_write(p_circle_buf pCircleBuf, uint8_t val)
{
	uint32_t next_w;
	
	next_w = pCircleBuf->w + 1;
	if (next_w == pCircleBuf->len)
		next_w = 0;
	
	if (next_w != pCircleBuf->r)
	{
		pCircleBuf->buf[pCircleBuf->w] = val;
		pCircleBuf->w = next_w;
		return 0;
	}
	else
	{
		return -1;
	}
}

```

## 4. ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºé˜²æ­¢æŒ‰é”®ä¸¢å¤±

ä¿®æ”¹åçš„ `key_timeout_func`

```c
static uint8_t g_data_buf[100];
static circle_buf g_key_bufs;

void key_timeout_func(void *args)
{
	uint8_t key_val;		//æŒ‰ä¸‹æ˜¯ 0x1ï¼Œæ¾å¼€æ˜¯ 0x81
	g_key_cnt++;
	key_timer.timeout = ~0;
	
	/* read gpio */
	if (HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_14) == GPIO_PIN_RESET)
		key_val = 0x1;
	else
		key_val = 0x81;
	
	/* put key val into circle buf */
	circle_buf_write(&g_key_bufs, key_val);
}

void mod_timer(struct soft_timer *pTimer, uint32_t timeout)
{
	pTimer->timeout = HAL_GetTick() + timeout;
}

void check_timer(void)
{
	if (key_timer.timeout <= HAL_GetTick())
	{
		key_timer.func(key_timer.args);
	}
}

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	if (GPIO_Pin == GPIO_PIN_14)
	{
		mod_timer(&key_timer, 10);
	}
}
```

`while (1)` ä¸­çš„å‡½æ•°

```c
while (1)
{
	OLED_PrintSignedVal(len, 0, g_key_cnt);
	uint8_t key_val = 0;
	if (0 == circle_buf_read(&g_key_bufs, &key_val))
	{
		OLED_ClearLine(len, 2);
		OLED_PrintHex(len, 2, key_val, 1);
	}
}
```