---
tags:
  - ARM
  - STM32
  - GPIO
  - 嵌入式
---

# 1. 硬件分析与引脚分配

在开始编程之前，首先需要分析电路原理图，确定按键和 LED 连接到微控制器的哪个引脚。

*   **100ASK STM32F103 按键原理图**
    ![](attachments/12_使用按键控制LED/001_stm32f103_key_sch.png)

*   **实验目标**：使用 `KEY1` 来控制红色 LED。具体功能为：按下 `KEY1`，LED 亮；松开 `KEY1`，LED 灭。

*   **引脚确定**：从原理图中可以看出，按键 `KEY1` 连接到 `PA0` 引脚。
    ![](attachments/12_使用按键控制LED/002_key1_pin.png)

# 2. 寄存器配置

为了使 `PA0` 引脚能够读取按键状态，需要对其相关的寄存器进行配置。这主要涉及三个步骤：

## 2.1 使能 GPIOA 时钟

所有外设在使用前都必须先使其能对应的时钟。GPIOA 挂载在 APB2 总线上，因此需要配置 `RCC_APB2ENR` 寄存器。

-   **寄存器**：`RCC_APB2ENR`
-   **地址**：`0x40021000 + 0x18`
-   **操作**：将 `IOPAEN` 位（Bit 2）置 1，以使能 GPIOA 的时钟。

![](attachments/12_使用按键控制LED/003_enable_gpioa.png)

## 2.2 配置 PA0 为输入模式

接下来，需要将 `PA0` 引脚配置为输入模式。对于 STM32F103 的 GPIO，每个端口有 `CRL` (控制低 8 位引脚) 和 `CRH` (控制高 8 位引脚) 两个配置寄存器。`PA0` 属于低 8 位，因此需要配置 `GPIOA_CRL` 寄存器。

-   **寄存器**：`GPIOA_CRL`
-   **地址**：`0x40010800 + 0x00`
-   **操作**：配置 `CNF0[1:0]` 和 `MODE0[1:0]` 位。作为按键输入，通常配置为上拉/下拉输入模式。

![](attachments/12_使用按键控制LED/004_config_gpioa.png)

## 2.3 读取引脚电平状态

配置完成后，可以通过读取 `GPIOA_IDR` (输入数据寄存器) 来获取 `PA0` 引脚的当前电平状态。

-   **寄存器**：`GPIOA_IDR`
-   **地址**：`0x40010800 + 0x08`
-   **操作**：读取 `IDR0` 位。如果 `KEY1` 被按下，`PA0` 会被拉低，`IDR0` 的值为 0；如果松开，`IDR0` 的值为 1（假设内部或外部有上拉）。

![](attachments/12_使用按键控制LED/005_read_gpio_data.png)

# 3. 编程实现思路

根据上述分析，具体的编程逻辑如下：

1.  **初始化 GPIO**：
    -   使能 GPIOA（用于按键）和 GPIOC（假设 LED 连接在 PC0）的时钟。
    -   将 LED 引脚（如 PC0）配置为推挽输出模式。
    -   将按键引脚（PA0）配置为上拉/下拉输入模式。

2.  **主循环**：
    -   在 `main` 函数的 `while(1)` 循环中，持续检测 PA0 引脚的电平。
    -   **判断按键状态**：读取 `GPIOA_IDR` 寄存器的值。
    -   **控制 LED**：
        -   如果检测到按键按下（例如，PA0 为低电平），则将 LED 引脚设置为高电平，点亮 LED。
        -   如果检测到按键松开（例如，PA0 为高电平），则将 LED 引脚设置为低电平，熄灭 LED。

---

**参考源码路径**：`doc_and_source_for_mcu_mpu\STM32MF103\source\02_录制视频时现场编写的源码\04_key_led`