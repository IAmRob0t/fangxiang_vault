---
tags:
  - arm
---
中断也属于一种异常

# 中断路径上的 3 个部件

- **中断源**
  中断源多种多样，比如 GPIO、定时器、UART、DMA 等等。
  它们都有自己的寄存器，可以进行相关设置：使能中断、中断状态、中断类型等等。
- **中断控制器**
  各种中断源发出的中断信号，汇聚到中断控制器。
  可以在中断控制器中设置各个中断的优先级。
  中断控制器会向 CPU 发出中断信号，CPU 可以读取中断控制器的寄存器，判断当前处理的是哪个中断。
  中断控制器有多种实现，比如：
	- STM32F103 中被称为 NVIC: Nested vectored interrupt controller（嵌套向量中断控制器）
	- ARM9 中一般是芯片厂家自己实现的，没有统一标准
	- Cortex A7 中使用 GIC （Generic Interrupt Controller）
- **CPU**
  CPU 每执行完一条指令，都会判断一下是否有中断发生了。
  CPU 也有自己的寄存器，可以设置它来使能/禁止中断，这是中断处理的总开关。

![](attachments/45_中断的硬件框架/002_exception_on_arm.png)

# STM32F103 的 GPIO 中断

参考资料：`STM32F103数据手册.pdf`、`ARM Cortex-M3与Cortex-M4权威指南.pdf`、`PM0056.pdf`

对于 GPIO 中断，STM32F103 又引入了 `External interrupt/event controller (EXTI)`。
用来设置 GPIO 的中断类型，如下图：

![](attachments/45_中断的硬件框架/017_stm32f103_gpio_to_nvic.png)

EXTI 可以给 NVIC 提供 16 个中断信号：EXTI0~EXTI15。
那么某个 EXTIx，它来自哪些 GPIO 呢？这需要设置 GPIO 控制器。

## GPIO 控制器

STM32F103 的 GPIO 控制器中有 AFIO_EXTICR1~AFIO_EXTICR4 一共 4 个寄存器
名为：External interrupt configuration register，外部中断配置寄存器。
用来选择某个外部中断 EXTIx 的中断源，示例如下：

![](attachments/45_中断的硬件框架/016_stm32f103_gpio_interrtup.png)

**注意**：从上图可知，EXTI0 只能从 PA0、……、PG0 中选择一个，这也意味着 PA0、……、PG0 中只有一个引脚可以用于中断。这跟其他芯片不一样，很多芯片的任一 GPIO 引脚都可以同时用于中断。

![](attachments/45_中断的硬件框架/025_external_int_gpio_mapping.png)

## EXTI

在 GPIO 控制器中，可以设置某个 GPIO 引脚作为中断源，给 EXTI 提供中断信号。
但是，这个中断的触发方式是怎么的？高电平触发、低电平触发、上升沿触发、下降沿触发？
这需要进一步设置。
EXTI 框图如下：

![](attachments/45_中断的硬件框架/018_stm32f103_exti.png)

沿着上面框图中的红线，我们要设置：

* Falling trigger selection register：是否选择下降沿触发
* Rising trigger selection register：是否选择上升沿触发
* Interrupt mask register：是否屏蔽中断

当发生中断时，可以读取下列寄存器判断是否发生了中断、发生了哪个中断：

* Pending reqeust register

要使用 EXTI，流程如下：

![](attachments/45_中断的硬件框架/019_stm32f103_how_to_use_exti.png)

翻译如下：

* 配置 EXTI_IMR：允许 EXTI 发出中断
* 配置 EXTI_RTSR、EXTI_FTSR，选择中断触发方式
* 配置 NVIC 中的寄存器，允许 NVIC 把中断发给 CPU

## NVIC

多个中断源汇聚到 NVIC，NVIC 的职责就是从多个中断源中取出优先级最高的中断，向 CPU 发出中断信号。
处理中断时，程序可以写 NVIC 的寄存器，清除中断。
涉及的寄存器：

![](attachments/45_中断的硬件框架/020_stm32f103_nvic_registers.png)

我们暂时只需要关注：ISER (中断设置使能寄存器)、ICPR (中断清除挂起寄存器)。
要注意的是，这些寄存器有很多个，比如 ISER0、ISER1 等等。里面的每一位对应一个中断。
ISER0 中的 bit0 对应异常向量表中的第 16 项 (向量表从第 0 项开始)，如下图：

![](attachments/45_中断的硬件框架/021_stm32f103_nvic_iser_icer.png)

## CPU

cortex M3/M4 处理器内部有这几个寄存器：

### PRIMASK

  ![](attachments/45_中断的硬件框架/022_cortex_m3_primask.png)

  把 PRIMASK 的 bit0 设置为 1，就可以屏蔽所有**优先级可配置**的中断。
  可以使用这些指令来设置它：

  ```
  CPSIE I  ; 清除PRIMASK，使能中断
  CPSID I  ; 设置PRIMASK，禁止中断
  
  或者：
  MOV R0, #1
  MSR  PRIMASK R0  ; 将1写入PRIMASK禁止所有中断
  
  MOV R0, #0
  MSR PRIMASK, R0  ; 将0写入PRIMASK使能所有中断
  ```

  

### FAULTMASK

![](attachments/45_中断的硬件框架/023_cortex_m3_faultmask.png)

  FAULTMASK 和 PRIMASK 很像，它更进一步，出来一般的中断外，把 HardFault 都禁止了。
  只有 NMI 可以发生。
  可以使用这些指令来设置它：

  ```
  CPSIE F  ; 清除FAULTMASK
  CPSID F  ; 设置FAULTMASK
  
  或者：
  MOV R0, #1
  MSR  FAULTMASK R0  ; 将1写入FAULTMASK禁止中断
  
  MOV R0, #0
  MSR FAULTMASK, R0  ; 将0写入FAULTMASK使能中断
  ```

  

### BASEPRI

![](attachments/45_中断的硬件框架/024_cortex_m3_basemask.png)

  BASEPRI 用来屏蔽这些中断：它们的优先级，其值大于或等于 BASEPRI。
  可以使用这些指令来设置它：

  ```
  MOVS R0, #0x60
  MSR BASEPRI, R0   ; 禁止优先级在0x60~0xFF间的中断
  
  MRS R0, BASEPRI   ; 读取BASEPRI
  
  MOVS R0, #0
  MSR BASEPRI, R0    ; 取消BASEPRI屏蔽
  ```


# STM32MP157 的 GPIO 中断

STM32MP157 的 GPIO 中断在硬件上的框架，跟 STM32F103 是类似的。
它们的中断控制器不一样，STM32MP157 中使用的是 GIC：

![](attachments/45_中断的硬件框架/026_stm32mp157_gpio_o_gic.png)

## GPIO 控制器

对于 STM32MP157，除了把 GPIO 引脚配置为输入功能外，GPIO 控制器里没有中断相关的寄存器。
请参考前面的课程《01_使用按键控制 LED (STM32MP157)》。

## EXTI

GPIO 引脚可以向 CPU 发出中断信号，所有的 GPIO 引脚都可以吗？
不是的，需要在 EXTI 控制器中设置、选择。
GPIO 引脚触发中断的方式是怎样的？高电平触发、低电平触发、上升沿触发、下降沿触发？
这需要进一步设置。
这些，都是在 EXTI 中配置，EXTI 框图如下：

![](attachments/45_中断的硬件框架/027_stm32mp157_exti.png)

沿着红线走：

### 设置 `EXTImux`

选择哪些 GPIO 可以发出中断。
只有 16 个 EXTI 中断，从 EXTI0~EXTI15；每个 EXTIx 中断只能从 PAx、PBx、……中选择某个引脚，如下图所示：

![](attachments/45_中断的硬件框架/028_stm32mp157_external_int_gpio_mapping.png)

**注意**：从上图可知，EXTI0 只能从 PA0、……中选择一个，这也意味着 PA0、……中只有一个引脚可以用于中断。这跟其他芯片不一样，很多芯片的任一 GPIO 引脚都可以同时用于中断。

通过 EXTI_EXTICR1 等寄存器来设置 EXTIx 的中断源是哪个 GPIO 引脚，入下图所示：

![](attachments/45_中断的硬件框架/029_stm32mp157_exti_exticr1.png)

### 设置 `Event Trigger`

设置中断触发方式：

![](attachments/45_中断的硬件框架/030_stm32mp157_exti_rtsr1_ftsr1.png)

### 设置 `Masking`

允许某个 EXTI 中断：

![](attachments/45_中断的硬件框架/031_stm32mp157_exti_imr1.png)

### 查看中断状态、清中断

![](attachments/45_中断的硬件框架/032_stm32mp157_exti_rpr1_fpr1.png)

## GIC

ARM 体系结构定义了通用中断控制器（GIC），该控制器包括一组用于管理单核或多核系统中的中断的硬件资源。GIC 提供了内存映射寄存器，可用于管理中断源和行为，以及（在多核系统中）用于将中断路由到各个 CPU 核。它使软件能够屏蔽，启用和禁用来自各个中断源的中断，以（在硬件中）对各个中断源进行优先级排序和生成软件触发中断。它还提供对 TrustZone 安全性扩展的支持。GIC 接受系统级别中断的产生，并可以发信号通知给它所连接的每个内核，从而有可能导致 IRQ 或 FIQ 异常发生。

GIC 比较复杂，下一个视频再详细讲解。

## CPU

CPU 的 CPSR 寄存器中有一位：I 位，用来使能/禁止中断。

![](attachments/45_中断的硬件框架/008_xpsr.png)

可以使用以下汇编指令修改 I 位：

```
  CPSIE I  ; 清除I位，使能中断
  CPSID I  ; 设置I位，禁止中断
```



# IMX6ULL 的 GPIO 中断

IMX6ULL 的 GPIO 中断在硬件上的框架，跟 STM32MP157 是类似的。
IMX6ULL 中没有 EXTI 控制器，对 GPIO 的中断配置、控制，都在 GPIO 模块内部实现：

![](attachments/45_中断的硬件框架/033_imx6ull_gpio_gic.png)

## GPIO 控制器

### 配置 GPIO 中断

每组 GPIO 中都有对应的 GPIOx_ICR1、GPIOx_ICR2 寄存器 (interrupt configuration register )。
每个引脚都可以配置为中断引脚，并配置它的触发方式：

![](attachments/45_中断的硬件框架/034_imx6ull_gpiox_icr1.png)

### 使能 GPIO 中断

![](attachments/45_中断的硬件框架/035_imx6ull_gpiox_imr.png)

### 判断中断状态、清中断

![](attachments/45_中断的硬件框架/036_imx6ull_gpiox_isr.png)

## GIC

ARM 体系结构定义了通用中断控制器（GIC），该控制器包括一组用于管理单核或多核系统中的中断的硬件资源。GIC 提供了内存映射寄存器，可用于管理中断源和行为，以及（在多核系统中）用于将中断路由到各个 CPU 核。它使软件能够屏蔽，启用和禁用来自各个中断源的中断，以（在硬件中）对各个中断源进行优先级排序和生成软件触发中断。它还提供对 TrustZone 安全性扩展的支持。GIC 接受系统级别中断的产生，并可以发信号通知给它所连接的每个内核，从而有可能导致 IRQ 或 FIQ 异常发生。

GIC 比较复杂，下一个视频再详细讲解。

## CPU

CPU 的 CPSR 寄存器中有一位：I 位，用来使能/禁止中断。

![](attachments/45_中断的硬件框架/008_xpsr.png)

可以使用以下汇编指令修改 I 位：

```
  CPSIE I  ; 清除I位，使能中断
  CPSID I  ; 设置I位，禁止中断
```

